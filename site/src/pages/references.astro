---
import BaseLayout from "../layouts/BaseLayout.astro";
import { referencesIntro, partners, refPhotos } from "../data/references";

const title = "Références — Usagi Délice";
const description =
  "Marques, institutions et festivals qui ont fait confiance à Usagi Délice. Découvrez nos collaborations et quelques photos de nos participations.";
---

<BaseLayout title={title} description={description}>
  <main class="refs">
    <!-- SECTION 1 -->
    <section class="hero">
      <div class="container hero-inner">
        <div class="hero-copy">
          <h1>{referencesIntro.title}</h1>
          <p class="sub">{referencesIntro.subtitle}</p>

          <div class="stats" aria-label="Aperçu">
            {
              referencesIntro.stats.map((s) => (
                <div class="stat">
                  <p class="stat-k">{s.k}</p>
                  <p class="stat-v">{s.v}</p>
                  <p class="stat-l">{s.label}</p>
                </div>
              ))
            }
          </div>
        </div>
      </div>
    </section>

    <!-- SECTION 2 -->
    <section class="partners" aria-label="Partenaires et événements">
      <div class="container">
        <div class="section-head">
          <h2>Partenaires & événements</h2>
          <p>
            Quelques marques, institutions et festivals avec lesquels nous avons
            collaboré.
          </p>
        </div>

        <div class="logo-wall" role="list">
          {
            partners.map((p) => (
              <div class="logo-tile" role="listitem" title={p.kind}>
                {p.logo ? (
                  <img src={p.logo} alt={p.name} loading="lazy" />
                ) : (
                  <>
                    <span class="logo-name">{p.name}</span>
                    <span class="logo-kind">{p.kind}</span>
                  </>
                )}
              </div>
            ))
          }
        </div>

        <div class="note">
          <p>
            Besoin d’un devis, d’une fiche technique ou d’un format sur mesure ?
            <a href="/contact">Contactez-nous</a>.
          </p>
        </div>
      </div>
    </section>

    <!-- SECTION 3 -->
    <section class="photos" aria-label="Photos d’événements">
      <div class="container">
        <div class="section-head">
          <h2>Quelques images de nos participations</h2>
          <p>
            Faites défiler (swipe sur mobile) — cliquez pour voir l’image en
            grand.
          </p>
        </div>
      </div>

      <div class="rail-wrap">
        <button class="rail-arrow left" data-rail-left aria-label="Précédent"
          >←</button
        >
        <button class="rail-arrow right" data-rail-right aria-label="Suivant"
          >→</button
        >

        <div class="rail" id="photos">
          {
            refPhotos.map((ph, i) => {
              const id = ph.id ?? `ph-${i + 1}`;
              const shape = ph.shape ?? "landscape";
              return (
                <a
                  class={`shot ${shape}`}
                  href={`#${id}`}
                  aria-label={`Voir: ${ph.caption}`}
                >
                  <img src={ph.src} alt={ph.alt} loading="lazy" />
                  <span class="tag">{ph.caption}</span>
                </a>
              );
            })
          }
        </div>
      </div>

      {/* Lightbox overlays (CSS :target, no library) */}
      {
        refPhotos.map((ph, i) => {
          const id = ph.id ?? `ph-${i + 1}`;
          const next = refPhotos[(i + 1) % refPhotos.length];
          const prev = refPhotos[(i - 1 + refPhotos.length) % refPhotos.length];
          const nextId = next.id ?? `ph-${((i + 1) % refPhotos.length) + 1}`;
          const prevId =
            prev.id ??
            `ph-${((i - 1 + refPhotos.length) % refPhotos.length) + 1}`;

          return (
            <section id={id} class="lb" aria-label={`Agrandir: ${ph.caption}`}>
              <a class="lb-backdrop" href="#photos" aria-label="Fermer" />

              <div class="lb-card" role="dialog" aria-modal="true">
                <div class="lb-top">
                  <div class="lb-title">
                    <p class="lb-k">Usagi Délice</p>
                    <p class="lb-cap">{ph.caption}</p>
                  </div>
                  <a class="lb-close" href="#photos" aria-label="Fermer">
                    ✕
                  </a>
                </div>

                <div class="lb-media">
                  <img src={ph.src} alt={ph.alt} />
                </div>

                <div class="lb-nav">
                  <a class="lb-btn" href={`#${prevId}`} aria-label="Précédent">
                    ←
                  </a>
                  <a class="lb-btn" href={`#${nextId}`} aria-label="Suivant">
                    →
                  </a>
                </div>
              </div>
            </section>
          );
        })
      }
    </section>
  </main>

  <style>
    /* Remove page-only effects that could harm readability */
    .refs,
    .refs * {
      filter: none !important;
    }
    .refs h1,
    .refs .sub {
      opacity: 1 !important;
      text-shadow: none !important;
    }
    .refs::before,
    .refs::after,
    .refs .hero::before,
    .refs .hero::after,
    .refs .container::before,
    .refs .container::after {
      content: none !important;
      display: none !important;
    }

    .refs {
      padding: calc(var(--header-h, 72px) + 12px) 0 64px;
    }

    /* SECTION 1 */
    .hero {
      padding: 10px 0 18px;
    }
    /* ✅ Do NOT narrow the page: keep global container width */
    .hero-inner {
      max-width: none;
    }

    h1 {
      margin: 0;
      letter-spacing: -0.03em;
      line-height: 1.02;
      font-size: clamp(2.1rem, 1.1rem + 3.1vw, 3.6rem);
    }
    .sub {
      margin: 12px 0 0;
      max-width: 70ch;
      color: rgba(42, 31, 31, 0.74);
      font-size: 1.05rem;
      line-height: 1.6;
    }
    .stats {
      margin-top: 16px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .stat {
      padding: 14px 16px;
      border-radius: 18px;
      background: rgba(255, 247, 239, 0.7);
      border: 1px solid rgba(42, 31, 31, 0.1);
      backdrop-filter: blur(10px);
    }
    .stat-k {
      margin: 0;
      font-size: 0.78rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: rgba(42, 31, 31, 0.6);
    }
    .stat-v {
      margin: 2px 0 0;
      font-weight: 950;
      font-size: 1.35rem;
      letter-spacing: -0.02em;
    }
    .stat-l {
      margin: 0;
      color: rgba(42, 31, 31, 0.62);
      font-size: 0.95rem;
    }

    /* SECTION headings */
    .section-head {
      /* ✅ match other pages: no forced 980px */
      max-width: none;
      margin: 0 0 14px;
    }
    .section-head h2 {
      margin: 0;
      letter-spacing: -0.02em;
      font-size: clamp(1.35rem, 1.1rem + 1vw, 1.8rem);
    }
    .section-head p {
      margin: 8px 0 0;
      color: rgba(42, 31, 31, 0.66);
      line-height: 1.6;
      max-width: 78ch;
    }

    /* SECTION 2 */
    .partners {
      padding: 18px 0 18px;
    }
    .logo-wall {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      /* ✅ no 980px clamp */
      max-width: none;
      margin: 0;
    }
    .logo-tile {
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 64px;
      padding: 14px 14px;
      border-radius: 18px;
      border: 1px solid rgba(42, 31, 31, 0.1);
      background: rgba(255, 255, 255, 0.22);
      backdrop-filter: blur(10px);
      transition:
        transform 0.15s ease,
        background 0.15s ease;
    }
    .logo-tile:hover {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, 0.34);
    }
    .logo-tile img {
      max-height: 30px;
      width: auto;
      opacity: 0.86;
      filter: grayscale(1);
    }
    .logo-name {
      font-weight: 950;
      letter-spacing: -0.01em;
      line-height: 1.1;
    }
    .logo-kind {
      margin-top: 4px;
      font-size: 0.88rem;
      color: rgba(42, 31, 31, 0.58);
    }
    .note {
      /* ✅ no 980px clamp */
      max-width: none;
      margin: 14px 0 0;
      color: rgba(42, 31, 31, 0.64);
    }
    .note a {
      color: var(--red, #c23b32);
      font-weight: 900;
      text-decoration: none;
    }
    .note a:hover {
      text-decoration: underline;
    }

    /* SECTION 3 — full-bleed, wide & modern */
    .photos {
      padding: 24px 0 0;
    }

    .rail-wrap {
      position: relative;
      width: min(1680px, calc(100vw - 24px));
      margin: 0 auto;
      box-sizing: border-box;
    }

    .rail-wrap:not(.is-scrollable) .rail-arrow {
      display: none !important;
    }

    .rail {
      width: 100%;
      /* ✅ important: remove earlier max-width constraints */
      max-width: none;
      margin: 0;
      display: flex;
      gap: 18px;
      overflow-x: auto;
      padding: 14px 64px 26px;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }

    .rail::-webkit-scrollbar {
      height: 6px;
    }
    .rail::-webkit-scrollbar-thumb {
      background: rgba(42, 31, 31, 0.1);
      border-radius: 999px;
    }

    .shot {
      position: relative;
      flex: 0 0 auto;
      height: 440px;
      border-radius: 18px;
      border: 1px solid rgba(42, 31, 31, 0.1);
      background: rgba(255, 255, 255, 0.14);
      overflow: hidden;
      scroll-snap-align: start;
      text-decoration: none;
      color: inherit;
      transition: transform 0.22s ease, box-shadow 0.22s ease;
      will-change: transform;
      outline: none;
      transform: translateY(var(--lift, 0px)) scale(var(--card-scale, 1));
      box-shadow: 0 18px 50px rgba(0,0,0,var(--shadow, 0));
    }
    .shot:hover {
      transform: translateY(calc(var(--lift, 0px) - 2px)) scale(var(--card-scale, 1));
    }
    .shot:focus-visible {
      outline: 3px solid rgba(194, 59, 50, 0.28);
      outline-offset: 3px;
    }

    .shot.landscape {
      aspect-ratio: 3 / 2;
    }
    .shot.portrait {
      aspect-ratio: 3 / 4;
    }
    .shot.square {
      aspect-ratio: 1 / 1;
    }

    .shot img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: transform 0.35s ease;
      will-change: transform;
    }

    /* Subtle Apple-like hover zoom */
    @media (hover: hover) and (pointer: fine) {
      .shot:hover img {
        transform: scale(1.03);
      }
    }

    .tag {
      position: absolute;
      left: 12px;
      bottom: 12px;
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 0.88rem;
      color: rgba(42, 31, 31, 0.9);
      background: rgba(255, 247, 239, 0.82);
      border: 1px solid rgba(42, 31, 31, 0.1);
      backdrop-filter: blur(10px);
      max-width: calc(100% - 24px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Arrows (desktop only) */
    .rail-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 1px solid rgba(42, 31, 31, 0.14);
      background: rgba(255, 255, 255, 0.65);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.18);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition:
        opacity 0.18s ease,
        transform 0.18s ease;
      z-index: 2;
    }
    .rail-wrap.is-scrollable:hover .rail-arrow {
      opacity: 0.92;
    }
    .rail-arrow.left {
      left: 14px;
    }
    .rail-arrow.right {
      right: 14px;
    }

    .rail-arrow.is-disabled {
      opacity: 0 !important;
      pointer-events: none;
      transform: translateY(-50%) scale(0.98);
    }

    @media (max-width: 860px) {
      .rail-arrow {
        display: none;
      }
      .rail {
        padding: 8px 12px 14px;
      }
      .shot {
        height: 320px;
      }
    }

    @media (min-width: 720px) {
      .stats {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
      .logo-wall {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }

    /* Lightbox */
    .lb {
      position: fixed;
      inset: 0;
      display: none;
      z-index: 80;
    }
    .lb:target {
      display: block;
    }
    .lb-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(20, 16, 16, 0.55);
      backdrop-filter: blur(10px);
    }
    .lb-card {
      position: relative;
      width: min(var(--container, 1120px), calc(100% - 28px));
      margin: 14px auto;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(255, 247, 239, 0.92);
      box-shadow: 0 30px 90px rgba(0, 0, 0, 0.35);
      overflow: hidden;
    }
    .lb-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(42, 31, 31, 0.1);
    }
    .lb-k {
      margin: 0;
      font-size: 0.78rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: rgba(42, 31, 31, 0.6);
      font-weight: 900;
    }
    .lb-cap {
      margin: 2px 0 0;
      font-weight: 950;
      letter-spacing: -0.01em;
    }
    .lb-close {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 38px;
      height: 38px;
      border-radius: 999px;
      border: 1px solid rgba(42, 31, 31, 0.14);
      background: rgba(255, 255, 255, 0.45);
      text-decoration: none;
      color: rgba(42, 31, 31, 0.85);
      font-weight: 900;
    }
    .lb-close:hover {
      background: rgba(255, 255, 255, 0.65);
    }

    .lb-media {
      background: rgba(255, 255, 255, 0.35);
    }
    .lb-media img {
      display: block;
      width: 100%;
      height: min(72vh, 720px);
      object-fit: contain;
      background: rgba(255, 255, 255, 0.18);
    }
    .lb-nav {
      display: flex;
      justify-content: space-between;
      padding: 12px 14px;
      border-top: 1px solid rgba(42, 31, 31, 0.1);
    }
    .lb-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(42, 31, 31, 0.14);
      background: rgba(255, 255, 255, 0.45);
      text-decoration: none;
      color: rgba(42, 31, 31, 0.85);
      font-weight: 900;
      min-width: 46px;
    }
    .lb-btn:hover {
      background: rgba(255, 255, 255, 0.65);
    }
  </style>

  <script is:inline>
    (() => {
      const rail = document.querySelector(".rail");
      const wrap = document.querySelector(".rail-wrap");
      const shotsForDepth = Array.from(rail ? rail.querySelectorAll('a.shot') : []);
      if (!rail || !wrap) return;

      const leftBtn = wrap.querySelector("[data-rail-left]");
      const rightBtn = wrap.querySelector("[data-rail-right]");

      const step = () => rail.clientWidth * 0.85;
      const isScrollable = () => rail.scrollWidth > rail.clientWidth + 2;

      const update = () => {
        const canScroll = isScrollable();
        wrap.classList.toggle("is-scrollable", canScroll);
        if (!canScroll) return;

        const atStart = rail.scrollLeft <= 2;
        const atEnd =
          rail.scrollLeft + rail.clientWidth >= rail.scrollWidth - 2;

        leftBtn && leftBtn.classList.toggle("is-disabled", atStart);
        rightBtn && rightBtn.classList.toggle("is-disabled", atEnd);
      };

      // Depth layering (Apple-like) — subtle lift/scale based on proximity to viewport center
      const prefersReduced =
        window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;
      const mqDesktop = window.matchMedia ? window.matchMedia("(min-width: 861px)") : { matches: true };

      let rafDepth = 0;
      const updateDepth = () => {
        if (prefersReduced || !mqDesktop.matches) {
          shotsForDepth.forEach((el) => {
            el.style.removeProperty("--lift");
            el.style.removeProperty("--card-scale");
            el.style.removeProperty("--shadow");
          });
          return;
        }

        const railRect = rail.getBoundingClientRect();
        const centerX = railRect.left + railRect.width / 2;
        const max = railRect.width * 0.55;

        shotsForDepth.forEach((el) => {
          const r = el.getBoundingClientRect();
          const x = r.left + r.width / 2;
          const dist = Math.abs(centerX - x);
          const t = Math.max(0, 1 - dist / max); // 0..1
          const lift = 10 * t;                  // px
          const scale = 1 + 0.02 * t;           // 1..1.02
          const shadow = 0.22 * t;              // alpha
          el.style.setProperty("--lift", `${lift.toFixed(2)}px`);
          el.style.setProperty("--card-scale", `${scale.toFixed(4)}`);
          el.style.setProperty("--shadow", `${shadow.toFixed(3)}`);
        });
      };

      const scheduleDepth = () => {
        if (rafDepth) return;
        rafDepth = window.requestAnimationFrame(() => {
          rafDepth = 0;
          updateDepth();
        });
      };


      rail.addEventListener(
        "wheel",
        (e) => {
          if (!isScrollable()) return;
          if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
            rail.scrollLeft += e.deltaY;
            e.preventDefault();
          }
        },
        { passive: false },
      );

      leftBtn &&
        leftBtn.addEventListener("click", () => {
          rail.scrollBy({ left: -step(), behavior: "smooth" });
        });
      rightBtn &&
        rightBtn.addEventListener("click", () => {
          rail.scrollBy({ left: step(), behavior: "smooth" });
        });

      rail.addEventListener("scroll", update, { passive: true });
      rail.addEventListener("scroll", scheduleDepth, { passive: true });
      window.addEventListener("resize", update, { passive: true });
      window.addEventListener("resize", scheduleDepth, { passive: true });

      update();
      scheduleDepth();
      window.setTimeout(() => { update(); scheduleDepth(); }, 120);
    })();
  </script>
</BaseLayout>
